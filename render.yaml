services:
  # ==========================================
  # Service Web N8N pour FREELANCEWAAR
  # ==========================================
  - type: web
    name: n8n-service
    runtime: docker
    region: frankfurt
    plan: free
    dockerfilePath: ./Dockerfile
    dockerContext: ./
    autoDeploy: true
    
    # ðŸ”Œ Configuration RÃ©seau
    healthCheckPath: /healthz
    
    # ðŸ§  Variables d'Environnement Critiques
    envVars:
      # === Base de DonnÃ©es PostgreSQL ===
      - key: DB_TYPE
        value: postgresdb
      
      - key: DB_POSTGRESDB_HOST
        fromDatabase:
          name: n8n-db
          property: host
      
      - key: DB_POSTGRESDB_PORT
        fromDatabase:
          name: n8n-db
          property: port
      
      - key: DB_POSTGRESDB_DATABASE
        fromDatabase:
          name: n8n-db
          property: database
      
      - key: DB_POSTGRESDB_USER
        fromDatabase:
          name: n8n-db
          property: user
      
      - key: DB_POSTGRESDB_PASSWORD
        fromDatabase:
          name: n8n-db
          property: password
      
      - key: DB_POSTGRESDB_SSL_ENABLED
        value: true
      
      - key: DB_POSTGRESDB_SSL_REJECT_UNAUTHORIZED
        value: false
      
      # === Configuration URLs (CRITIQUE pour OAuth) ===
      - key: N8N_HOST
        value: n8n-service-4bbb.onrender.com
      
      - key: N8N_PORT
        value: 5678
      
      - key: N8N_PROTOCOL
        value: https
      
      - key: N8N_EDITOR_BASE_URL
        value: https://n8n-service-4bbb.onrender.com
      
      - key: WEBHOOK_URL
        value: https://n8n-service-4bbb.onrender.com
      
      # === SÃ©curitÃ© ===
      - key: N8N_ENCRYPTION_KEY
        generateValue: true
      
      - key: N8N_USER_MANAGEMENT_JWT_SECRET
        generateValue: true
      
      - key: N8N_SECURE_COOKIE
        value: false
      
      # === Optimisation MÃ©moire (Plan Gratuit) ===
      - key: NODE_OPTIONS
        value: --max-old-space-size=450
      
      - key: N8N_RUNNERS_DISABLED
        value: true
      
      - key: EXECUTIONS_PROCESS
        value: main
      
      # === Nettoyage Automatique ===
      - key: EXECUTIONS_DATA_PRUNE
        value: true
      
      - key: EXECUTIONS_DATA_MAX_AGE
        value: 168
      
      - key: EXECUTIONS_DATA_SAVE_ON_SUCCESS
        value: none
      
      - key: EXECUTIONS_DATA_SAVE_ON_ERROR
        value: all
      
      - key: EXECUTIONS_DATA_SAVE_MANUAL_EXECUTIONS
        value: true
      
      # === Performance ===
      - key: N8N_METRICS
        value: false
      
      - key: N8N_LOG_LEVEL
        value: warn
      
      # === Timezone (Dakar) ===
      - key: GENERIC_TIMEZONE
        value: Africa/Dakar
      
      - key: TZ
        value: Africa/Dakar
      
      # === Configuration FREELANCEWAAR ===
      - key: N8N_PERSONALIZATION_ENABLED
        value: false

# ==========================================
# Base de DonnÃ©es PostgreSQL
# ==========================================
databases:
  - name: n8n-db
    databaseName: n8n_db_m04h
    region: frankfurt
    plan: free
    postgresMajorVersion: 15
    ipAllowList: []
